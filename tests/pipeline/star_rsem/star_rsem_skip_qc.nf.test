nextflow_pipeline {

    name "Test Workflow main.nf"
    script "main.nf"
    options "-profile test,docker"
    tag "pipeline"

    test("STAR RSEM (Skip QC) (GSE110004)") {

        when {
            params {
                outdir = "$outputDir"
                aligner = "star_rsem"
                skip_qc = true
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert snapshot(path("$outputDir/pipeline_info/software_versions.yml")).match("software_versions") },
                { assert snapshot(path("$outputDir/pipeline_info/samplesheet.valid.csv")).match("samplesheet") },
                { assert snapshot(path("$outputDir/bbsplit/RAP1_IAA_30M_REP1.stats.txt"),
                                path("$outputDir/bbsplit/RAP1_UNINDUCED_REP1.stats.txt"),
                                path("$outputDir/bbsplit/RAP1_UNINDUCED_REP2.stats.txt"),
                                path("$outputDir/bbsplit/WT_REP1.stats.txt")).match("bbsplit") },
                { assert new File("$outputDir/bbsplit/WT_REP2.stats.txt").exists() },
                { assert snapshot(path("$outputDir/multiqc/star_rsem/multiqc_data/multiqc_cutadapt.txt"),
                                path("$outputDir/multiqc/star_rsem/multiqc_data/multiqc_fastqc.txt"),
                                path("$outputDir/multiqc/star_rsem/multiqc_data/picard_histogram.txt")).match("multiqc") },
                { assert new File("$outputDir/multiqc/star_rsem/multiqc_data/multiqc_picard_dups.txt").exists() },
                { assert new File("$outputDir/multiqc/star_rsem/multiqc_data/multiqc_rsem.txt").exists() },
                { assert new File("$outputDir/multiqc/star_rsem/multiqc_data/multiqc_general_stats.txt").exists() },
                { assert new File("$outputDir/multiqc/star_rsem/multiqc_data/multiqc_samtools_flagstat.txt").exists() },
                { assert new File("$outputDir/multiqc/star_rsem/multiqc_data/multiqc_samtools_idxstats.txt").exists() },
                { assert new File("$outputDir/multiqc/star_rsem/multiqc_data/multiqc_samtools_stats.txt").exists() },
                { assert snapshot(path("$outputDir/salmon/salmon_tx2gene.tsv")).match("salmon") },
                { assert new File("$outputDir/salmon/salmon.merged.gene_counts.tsv").exists() },
                { assert new File("$outputDir/salmon/salmon.merged.transcript_counts.tsv").exists() },
                { assert new File("$outputDir/salmon/RAP1_IAA_30M_REP1/quant.sf").exists() },
                { assert new File("$outputDir/salmon/RAP1_IAA_30M_REP1/quant.genes.sf").exists() },
                { assert new File("$outputDir/salmon/RAP1_UNINDUCED_REP1/quant.sf").exists() },
                { assert new File("$outputDir/salmon/RAP1_UNINDUCED_REP1/quant.genes.sf").exists() },
                { assert new File("$outputDir/salmon/RAP1_UNINDUCED_REP2/quant.sf").exists() },
                { assert new File("$outputDir/salmon/RAP1_UNINDUCED_REP2/quant.genes.sf").exists() },
                { assert new File("$outputDir/salmon/WT_REP1/quant.sf").exists() },
                { assert new File("$outputDir/salmon/WT_REP1/quant.genes.sf").exists() },
                { assert new File("$outputDir/salmon/WT_REP2/quant.sf").exists() },
                { assert new File("$outputDir/salmon/WT_REP2/quant.genes.sf").exists() },
                { assert snapshot(path("$outputDir/star_rsem/bigwig/RAP1_IAA_30M_REP1.forward.bigWig"),
                                path("$outputDir/star_rsem/bigwig/RAP1_IAA_30M_REP1.reverse.bigWig"),
                                path("$outputDir/star_rsem/bigwig/RAP1_UNINDUCED_REP1.forward.bigWig"),
                                path("$outputDir/star_rsem/bigwig/RAP1_UNINDUCED_REP1.reverse.bigWig"),
                                path("$outputDir/star_rsem/bigwig/RAP1_UNINDUCED_REP2.forward.bigWig"),
                                path("$outputDir/star_rsem/bigwig/RAP1_UNINDUCED_REP2.reverse.bigWig"),
                                path("$outputDir/star_rsem/bigwig/WT_REP1.forward.bigWig"),
                                path("$outputDir/star_rsem/bigwig/WT_REP1.reverse.bigWig")).match("star_rsem/bigwig/") },
                { assert new File("$outputDir/star_rsem/bigwig/WT_REP2.forward.bigWig").exists() },
                { assert new File("$outputDir/star_rsem/bigwig/WT_REP2.reverse.bigWig").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/RAP1_IAA_30M_REP1.markdup.sorted.bam.flagstat").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/RAP1_IAA_30M_REP1.markdup.sorted.bam.idxstats").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/RAP1_IAA_30M_REP1.markdup.sorted.bam.stats").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/RAP1_IAA_30M_REP1.sorted.bam.flagstat").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/RAP1_IAA_30M_REP1.sorted.bam.idxstats").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/RAP1_IAA_30M_REP1.sorted.bam.stats").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/RAP1_UNINDUCED_REP1.markdup.sorted.bam.flagstat").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/RAP1_UNINDUCED_REP1.markdup.sorted.bam.idxstats").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/RAP1_UNINDUCED_REP1.markdup.sorted.bam.stats").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/RAP1_UNINDUCED_REP1.sorted.bam.flagstat").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/RAP1_UNINDUCED_REP1.sorted.bam.idxstats").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/RAP1_UNINDUCED_REP1.sorted.bam.stats").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/RAP1_UNINDUCED_REP2.markdup.sorted.bam.flagstat").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/RAP1_UNINDUCED_REP2.markdup.sorted.bam.idxstats").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/RAP1_UNINDUCED_REP2.markdup.sorted.bam.stats").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/RAP1_UNINDUCED_REP2.sorted.bam.flagstat").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/RAP1_UNINDUCED_REP2.sorted.bam.idxstats").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/RAP1_UNINDUCED_REP2.sorted.bam.stats").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/WT_REP1.markdup.sorted.bam.flagstat").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/WT_REP1.markdup.sorted.bam.idxstats").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/WT_REP1.markdup.sorted.bam.stats").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/WT_REP1.sorted.bam.flagstat").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/WT_REP1.sorted.bam.idxstats").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/WT_REP1.sorted.bam.stats").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/WT_REP2.markdup.sorted.bam.flagstat").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/WT_REP2.markdup.sorted.bam.idxstats").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/WT_REP2.markdup.sorted.bam.stats").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/WT_REP2.sorted.bam.flagstat").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/WT_REP2.sorted.bam.idxstats").exists() },
                { assert new File("$outputDir/star_rsem/samtools_stats/WT_REP2.sorted.bam.stats").exists() },
                { assert new File("$outputDir/star_rsem/stringtie/RAP1_IAA_30M_REP1.gene.abundance.txt").exists() },
                { assert new File("$outputDir/star_rsem/stringtie/RAP1_UNINDUCED_REP1.gene.abundance.txt").exists() },
                { assert new File("$outputDir/star_rsem/stringtie/RAP1_UNINDUCED_REP2.gene.abundance.txt").exists() },
                { assert new File("$outputDir/star_rsem/stringtie/WT_REP1.gene.abundance.txt").exists() },
                { assert new File("$outputDir/star_rsem/stringtie/WT_REP2.gene.abundance.txt").exists() },
                { assert new File("$outputDir/star_rsem/stringtie/RAP1_IAA_30M_REP1.coverage.gtf").exists() },
                { assert new File("$outputDir/star_rsem/stringtie/RAP1_UNINDUCED_REP1.coverage.gtf").exists() },
                { assert new File("$outputDir/star_rsem/stringtie/RAP1_UNINDUCED_REP2.coverage.gtf").exists() },
                { assert new File("$outputDir/star_rsem/stringtie/WT_REP1.coverage.gtf").exists() },
                { assert new File("$outputDir/star_rsem/stringtie/WT_REP2.coverage.gtf").exists() },
                { assert new File("$outputDir/star_rsem/stringtie/RAP1_IAA_30M_REP1.transcripts.gtf").exists() },
                { assert new File("$outputDir/star_rsem/stringtie/RAP1_UNINDUCED_REP1.transcripts.gtf").exists() },
                { assert new File("$outputDir/star_rsem/stringtie/RAP1_UNINDUCED_REP2.transcripts.gtf").exists() },
                { assert new File("$outputDir/star_rsem/stringtie/WT_REP1.transcripts.gtf").exists() },
                { assert new File("$outputDir/star_rsem/stringtie/WT_REP2.transcripts.gtf").exists() },
                { assert snapshot(path("$outputDir/star_rsem/RAP1_IAA_30M_REP1.genes.results"),
                                path("$outputDir/star_rsem/RAP1_IAA_30M_REP1.isoforms.results"),
                                path("$outputDir/star_rsem/RAP1_UNINDUCED_REP1.genes.results"),
                                path("$outputDir/star_rsem/RAP1_UNINDUCED_REP1.isoforms.results"),
                                path("$outputDir/star_rsem/RAP1_UNINDUCED_REP2.genes.results"),
                                path("$outputDir/star_rsem/RAP1_UNINDUCED_REP2.isoforms.results"),
                                path("$outputDir/star_rsem/WT_REP1.genes.results"),
                                path("$outputDir/star_rsem/WT_REP1.isoforms.results"),
                                path("$outputDir/star_rsem/WT_REP2.genes.results"),
                                path("$outputDir/star_rsem/WT_REP2.isoforms.results")).match("star_rsem") },
                { assert new File("$outputDir/star_rsem/RAP1_IAA_30M_REP1.markdup.sorted.bam").exists() },
                { assert new File("$outputDir/star_rsem/RAP1_IAA_30M_REP1.markdup.sorted.bam.bai").exists() },
                { assert new File("$outputDir/star_rsem/WT_REP1.markdup.sorted.bam").exists() },
                { assert new File("$outputDir/star_rsem/WT_REP1.markdup.sorted.bam.bai").exists() },
                { assert new File("$outputDir/star_rsem/RAP1_UNINDUCED_REP1.markdup.sorted.bam").exists() },
                { assert new File("$outputDir/star_rsem/RAP1_UNINDUCED_REP1.markdup.sorted.bam.bai").exists() },
                { assert new File("$outputDir/star_rsem/WT_REP2.markdup.sorted.bam").exists() },
                { assert new File("$outputDir/star_rsem/WT_REP2.markdup.sorted.bam.bai").exists() },
                { assert new File("$outputDir/star_rsem/RAP1_UNINDUCED_REP2.markdup.sorted.bam").exists() },
                { assert new File("$outputDir/star_rsem/RAP1_UNINDUCED_REP2.markdup.sorted.bam.bai").exists() },
                { assert new File("$outputDir/star_rsem/log/RAP1_IAA_30M_REP1.log").exists() },
                { assert new File("$outputDir/star_rsem/log/RAP1_UNINDUCED_REP1.log").exists() },
                { assert new File("$outputDir/star_rsem/log/RAP1_UNINDUCED_REP2.log").exists() },
                { assert new File("$outputDir/star_rsem/log/WT_REP1.log").exists() },
                { assert new File("$outputDir/star_rsem/log/WT_REP2.log").exists() },
                { assert new File("$outputDir/star_rsem/picard_metrics/RAP1_IAA_30M_REP1.markdup.sorted.MarkDuplicates.metrics.txt").exists() },
                { assert new File("$outputDir/star_rsem/picard_metrics/RAP1_UNINDUCED_REP1.markdup.sorted.MarkDuplicates.metrics.txt").exists() },
                { assert new File("$outputDir/star_rsem/picard_metrics/RAP1_UNINDUCED_REP2.markdup.sorted.MarkDuplicates.metrics.txt").exists() },
                { assert new File("$outputDir/star_rsem/picard_metrics/WT_REP1.markdup.sorted.MarkDuplicates.metrics.txt").exists() },
                { assert new File("$outputDir/star_rsem/picard_metrics/WT_REP2.markdup.sorted.MarkDuplicates.metrics.txt").exists() },
                { assert new File("$outputDir/trimgalore/RAP1_IAA_30M_REP1_1.fastq.gz_trimming_report.txt").exists() },
                { assert new File("$outputDir/trimgalore/RAP1_IAA_30M_REP1_2.fastq.gz_trimming_report.txt").exists() },
                { assert new File("$outputDir/trimgalore/RAP1_UNINDUCED_REP1.fastq.gz_trimming_report.txt").exists() },
                { assert new File("$outputDir/trimgalore/RAP1_UNINDUCED_REP2.fastq.gz_trimming_report.txt").exists() },
                { assert new File("$outputDir/trimgalore/WT_REP1_1.fastq.gz_trimming_report.txt").exists() },
                { assert new File("$outputDir/trimgalore/WT_REP1_2.fastq.gz_trimming_report.txt").exists() },
                { assert new File("$outputDir/trimgalore/WT_REP2_1.fastq.gz_trimming_report.txt").exists() },
                { assert new File("$outputDir/trimgalore/WT_REP2_2.fastq.gz_trimming_report.txt").exists() }
            )
        }

    }

}
